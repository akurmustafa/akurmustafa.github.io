<!DOCTYPE html><html><head>
      <title>query_optimization_part1</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/akurmustafa/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.13/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<p><img src="images/clock_header.jpg" alt="clock_header.jpg"></p>
<h1 id="query-optimization---part-1">Query Optimization - Part 1 </h1>
<p>In this series of blog posts. I will talk about query optimization in general. However, before doing so; In this blog post we will cover</p>
<ul>
<li>SQL</li>
<li>Logical Plan, Physical Plan</li>
<li>How to read a Plan</li>
<li>Motivating Example for query optimization</li>
</ul>
<p>These topics will lay the foundation for query optimization, will establish a common vocabulary and hopefully make reader motivate for subsequent parts.</p>
<p>In subsequent parts: I plan to cover following optimizations:</p>
<ul>
<li>Filter Push-down</li>
<li>Projection Optimization</li>
<li>Sort Optimization and Ordering Propagation</li>
<li>Parallelization of the plan execution</li>
<li>Common Sub-expression caching</li>
<li>Join re-ordering</li>
</ul>
<h2 id="what-is-sql">What is SQL: </h2>
<p>SQL (Structured Query Language) is a descriptive language that is used to interact with databases. An SQL query specifies the desired output by the user. However, it doesn’t specify how to calculate desired output during execution. As an example, following SQL query:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-SELECT">SELECT</span> name<span class="token punctuation">,</span> surname
<span class="token keyword keyword-FROM">FROM</span> student_table
<span class="token keyword keyword-WHERE">WHERE</span> major<span class="token operator">=</span><span class="token string">'Mathematics'</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> id<span class="token punctuation">;</span>
</code></pre><p>can be translated to english as</p>
<blockquote>
<p>Bring me the name, and surnames of the each student who majors in Mathematics where result is ordered by student id.</p>
</blockquote>
<p>However, it says nothing about how to accomplish this. For most of the queries, especially for complex queries there are many possible ways to calculate desired result with various tradeoffs.</p>
<p>From this specification, a query is pretty opaque to end user which is fine for most of the users who don’t and shouldn’t care. However, if we work on performance and optimization. We need to inspect internals of the query execution better. <code>LogicalPlan</code> and <code>PhysicalPlan</code> enables us to see what a query does, how it executes in a friendly format.</p>
<p>Before continuing, in case anyone wants to try out the same queries locally. Here is the query to generate necessary table locally.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> <span class="token keyword keyword-IF">IF</span> <span class="token operator">NOT</span> <span class="token keyword keyword-EXISTS">EXISTS</span> student_table<span class="token punctuation">(</span>id <span class="token keyword keyword-INT">INT</span><span class="token punctuation">,</span> name <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">,</span> surname <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">,</span> major <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">,</span> country <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">)</span> 
     <span class="token keyword keyword-AS">AS</span> <span class="token keyword keyword-VALUES">VALUES</span><span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">,</span> <span class="token string">'Mustafa'</span><span class="token punctuation">,</span> <span class="token string">'Demir'</span><span class="token punctuation">,</span> <span class="token string">'Mathematics'</span><span class="token punctuation">,</span> <span class="token string">'TUR'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
              <span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">'Jack'</span><span class="token punctuation">,</span> <span class="token string">'Hu'</span><span class="token punctuation">,</span> <span class="token string">'CS'</span><span class="token punctuation">,</span> <span class="token string">'US'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
              <span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token string">'Gerard'</span><span class="token punctuation">,</span> <span class="token string">'Depardieu'</span><span class="token punctuation">,</span> <span class="token string">'Mathematics'</span><span class="token punctuation">,</span> <span class="token string">'FR'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token string">'Steven'</span><span class="token punctuation">,</span> <span class="token string">'Smith'</span><span class="token punctuation">,</span> <span class="token string">'Mathematics'</span><span class="token punctuation">,</span> <span class="token string">'UK'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token string">'Ekaterina'</span><span class="token punctuation">,</span> <span class="token string">'Mihailov'</span><span class="token punctuation">,</span> <span class="token string">'Physics'</span><span class="token punctuation">,</span> <span class="token string">'RUS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><p>Also please note that I execute these queries using <a href="https://arrow.apache.org/datafusion/user-guide/cli.html">cli</a> tool of <a href="https://arrow.apache.org/datafusion/">Apache Datafusion</a>. This is the system I am most familiar with, However results and corresponding queries should be (almost) same in other query engines (configuration options might be pretty different though).</p>
<h2 id="logical-plan---physical-plan">Logical Plan - Physical Plan </h2>
<p>A <code>LogicalPlan</code> contains the necessary logical steps to compute query result. However, this representation is in high level, and omits lots of details related to the actual execution. I like to think <code>LogicalPlan</code> more like pseudo code, where you can see the general picture without bogging down in detail or specificities. In contrast <code>PhysicalPlan</code> is more like implementation of a pseudocode in a specific language. Anyone knowing the internals of the query engine can understand what is going on (like reading a code) by reading the <code>PhysicalPlan</code>. However, for this blog post <code>Logical Plan</code> representation will be enough for our use cases. Let’s see the<code>Logical Plan</code>  Datafusion generates for the query above by executing following command:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- Generate only logical plan</span>
<span class="token keyword keyword-set">set</span> datafusion<span class="token punctuation">.</span><span class="token keyword keyword-explain">explain</span><span class="token punctuation">.</span>logical_plan_only <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">-- See the plan for query</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-SELECT">SELECT</span> name<span class="token punctuation">,</span> surname
<span class="token keyword keyword-FROM">FROM</span> student_table
<span class="token keyword keyword-WHERE">WHERE</span> major<span class="token operator">=</span><span class="token string">'Mathematics'</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> id<span class="token punctuation">;</span>
</code></pre><p>where original query is prepended with <code>EXPLAIN</code> keyword and configuration is set logical plan only mode to not clutter result with physical plan for now. Command above produces following <code>Logical Plan</code>:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token operator">+</span><span class="token comment">--------------+-----------------------------------------------------------------------------+</span>
<span class="token operator">|</span> plan_type    <span class="token operator">|</span> <span class="token keyword keyword-plan">plan</span>                                                                        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+-----------------------------------------------------------------------------+</span>
<span class="token operator">|</span> logical_plan <span class="token operator">|</span> Projection: student_table<span class="token punctuation">.</span>name<span class="token punctuation">,</span> student_table<span class="token punctuation">.</span>surname                       <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>   Sort: student_table<span class="token punctuation">.</span>id <span class="token keyword keyword-ASC">ASC</span> NULLS <span class="token keyword keyword-LAST">LAST</span>                                     <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>     Projection: student_table<span class="token punctuation">.</span>name<span class="token punctuation">,</span> student_table<span class="token punctuation">.</span>surname<span class="token punctuation">,</span> student_table<span class="token punctuation">.</span>id <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>       Filter: student_table<span class="token punctuation">.</span>major <span class="token operator">=</span> Utf8<span class="token punctuation">(</span><span class="token string">"Mathematics"</span><span class="token punctuation">)</span>                     <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>         TableScan: student_table projection<span class="token operator">=</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> surname<span class="token punctuation">,</span> major<span class="token punctuation">]</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+-----------------------------------------------------------------------------+</span>
</code></pre><p>A <code>Logical Plan</code> contains the necessary steps to produce the desired result according to specifications of the SQL query, where each step is represented as single line and executes from bottom to top. To better understand this representation, let’s look the equivalent <code>Logical Plan</code> as tree.</p>
<p><img src="images/logical_plan_tree.png" alt="logical_plan_tree.png"></p>
<p>where each arrow show the data flow during execution. These two representations are completely same. In the first representation dependency between operators are specified by the indentation level (e.g The operator(s) with 2 indentation level ahead of an operator is the child(ren) of the operator). First representation is more concise, more text friendly. However, it maybe intimidating at the start. Second representation is more friendly, however fills up lots of space.</p>
<p>Logical Plan above describes following steps in order</p>
<ul>
<li>Scan the each row of the original table, where only columns: <code>id, name, surname, major</code> are used.</li>
<li>Among scanned rows, just keep the rows where <code>major</code> is ‘Mathematics’.</li>
<li>Shuffle columns such that new column order is <code>name</code>, <code>surname</code>, <code>id</code> respectively, where column <code>major</code> is pruned also.</li>
<li>Sort constructed rows according to id columns</li>
<li>Shuffle columns such that new column order is <code>name</code>, <code>surname</code> respectively, where column <code>id</code> is pruned.</li>
</ul>
<p>To see what is going on better, let’s see the data that is passed between operators. At the source(this can be a file, a kafka topic, etc.) following table resides</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>surname</th>
<th>major</th>
<th>country</th>
</tr>
</thead>
<tbody>
<tr>
<td>103</td>
<td>Mustafa</td>
<td>Demir</td>
<td>Mathematics</td>
<td>TUR</td>
</tr>
<tr>
<td>101</td>
<td>Jack</td>
<td>Hu</td>
<td>CS</td>
<td>US</td>
</tr>
<tr>
<td>105</td>
<td>Gerard</td>
<td>Depardieu</td>
<td>Mathematics</td>
<td>FR</td>
</tr>
<tr>
<td>102</td>
<td>Steven</td>
<td>Smith</td>
<td>Mathematics</td>
<td>UK</td>
</tr>
<tr>
<td>104</td>
<td>Ekaterina</td>
<td>Mihailov</td>
<td>Physics</td>
<td>RUS</td>
</tr>
</tbody>
</table>
<p><code>TableScan</code> operator emits following table to its output (where <code>Column=country</code> is pruned.)</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>surname</th>
<th>major</th>
</tr>
</thead>
<tbody>
<tr>
<td>103</td>
<td>Mustafa</td>
<td>Demir</td>
<td>Mathematics</td>
</tr>
<tr>
<td>101</td>
<td>Jack</td>
<td>Hu</td>
<td>CS</td>
</tr>
<tr>
<td>105</td>
<td>Gerard</td>
<td>Depardieu</td>
<td>Mathematics</td>
</tr>
<tr>
<td>102</td>
<td>Steven</td>
<td>Smith</td>
<td>Mathematics</td>
</tr>
<tr>
<td>104</td>
<td>Ekaterina</td>
<td>Mihailov</td>
<td>Physics</td>
</tr>
</tbody>
</table>
<p><code>Filter</code> operator emits following table</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>surname</th>
<th>major</th>
</tr>
</thead>
<tbody>
<tr>
<td>103</td>
<td>Mustafa</td>
<td>Demir</td>
<td>Mathematics</td>
</tr>
<tr>
<td>105</td>
<td>Gerard</td>
<td>Depardieu</td>
<td>Mathematics</td>
</tr>
<tr>
<td>102</td>
<td>Steven</td>
<td>Smith</td>
<td>Mathematics</td>
</tr>
</tbody>
</table>
<p>where 2<sup>nd</sup>, 5<sup>th</sup> row in the input table is removed, since their <code>major</code> value is not <code>Mathematics</code><em>.</em></p>
<p>First <code>Projection</code> emits following table</p>
<table>
<thead>
<tr>
<th>name</th>
<th>surname</th>
<th>id</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mustafa</td>
<td>Demir</td>
<td>103</td>
</tr>
<tr>
<td>Gerard</td>
<td>Depardieu</td>
<td>105</td>
</tr>
<tr>
<td>Steven</td>
<td>Smith</td>
<td>102</td>
</tr>
</tbody>
</table>
<p>where <code>Column</code>: <code>major</code> is removed, then  columns are re-ordered.</p>
<p><code>Sort</code> operator emit following table, where rows are re-ordered such that id column is Ascending.</p>
<table>
<thead>
<tr>
<th>name</th>
<th>surname</th>
<th>id</th>
</tr>
</thead>
<tbody>
<tr>
<td>Steven</td>
<td>Smith</td>
<td>102</td>
</tr>
<tr>
<td>Mustafa</td>
<td>Demir</td>
<td>103</td>
</tr>
<tr>
<td>Gerard</td>
<td>Depardieu</td>
<td>105</td>
</tr>
</tbody>
</table>
<p>Then, final <code>Projection</code> emits following table:</p>
<table>
<thead>
<tr>
<th>name</th>
<th>surname</th>
</tr>
</thead>
<tbody>
<tr>
<td>Steven</td>
<td>Smith</td>
</tr>
<tr>
<td>Mustafa</td>
<td>Demir</td>
</tr>
<tr>
<td>Gerard</td>
<td>Depardieu</td>
</tr>
</tbody>
</table>
<p>where id column <code>id</code> removed. This is the result seen at the output by the user. For the query</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-SELECT">SELECT</span> name<span class="token punctuation">,</span> surname
<span class="token keyword keyword-FROM">FROM</span> student_table
<span class="token keyword keyword-WHERE">WHERE</span> major<span class="token operator">=</span><span class="token string">'Mathematics'</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> id<span class="token punctuation">;</span>
</code></pre><p>Datafusion emits following result:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token operator">+</span><span class="token comment">---------+-----------+</span>
<span class="token operator">|</span> name    <span class="token operator">|</span> surname   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+</span>
<span class="token operator">|</span> Steven  <span class="token operator">|</span> Smith     <span class="token operator">|</span>
<span class="token operator">|</span> Mustafa <span class="token operator">|</span> Demir     <span class="token operator">|</span>
<span class="token operator">|</span> Gerard  <span class="token operator">|</span> Depardieu <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+</span>
</code></pre><p>If we carefully track data passed between operators we can see that only absolutely necessary data is passed between operators which is good. To see the difference a query optimization have, let’s see an alternative valid plan that would generate the same result.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token operator">+</span><span class="token comment">--------------+------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> plan_type    <span class="token operator">|</span> <span class="token keyword keyword-plan">plan</span>                                                                               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> logical_plan <span class="token operator">|</span> Projection: student_table<span class="token punctuation">.</span>name<span class="token punctuation">,</span> student_table<span class="token punctuation">.</span>surname                              <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>   Filter: student_table<span class="token punctuation">.</span>major <span class="token operator">=</span> Utf8<span class="token punctuation">(</span><span class="token string">"Mathematics"</span><span class="token punctuation">)</span>                                <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>     Sort: student_table<span class="token punctuation">.</span>id <span class="token keyword keyword-ASC">ASC</span> NULLS <span class="token keyword keyword-LAST">LAST</span>                                          <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>       TableScan: student_table projection<span class="token operator">=</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> surname<span class="token punctuation">,</span> major<span class="token punctuation">,</span> country<span class="token punctuation">]</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------------------------------------------------------------------------------+</span>
</code></pre><p>Let’s examine data passed between operators for this hypothetical plan. As before source is following table:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>surname</th>
<th>major</th>
<th>country</th>
</tr>
</thead>
<tbody>
<tr>
<td>103</td>
<td>Mustafa</td>
<td>Demir</td>
<td>Mathematics</td>
<td>TUR</td>
</tr>
<tr>
<td>101</td>
<td>Jack</td>
<td>Hu</td>
<td>CS</td>
<td>US</td>
</tr>
<tr>
<td>105</td>
<td>Gerard</td>
<td>Depardieu</td>
<td>Mathematics</td>
<td>FR</td>
</tr>
<tr>
<td>102</td>
<td>Steven</td>
<td>Smith</td>
<td>Mathematics</td>
<td>UK</td>
</tr>
<tr>
<td>104</td>
<td>Ekaterina</td>
<td>Mihailov</td>
<td>Physics</td>
<td>RUS</td>
</tr>
</tbody>
</table>
<p>and <code>TableScan</code> emits exact same table, which is:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>surname</th>
<th>major</th>
<th>country</th>
</tr>
</thead>
<tbody>
<tr>
<td>103</td>
<td>Mustafa</td>
<td>Demir</td>
<td>Mathematics</td>
<td>TUR</td>
</tr>
<tr>
<td>101</td>
<td>Jack</td>
<td>Hu</td>
<td>CS</td>
<td>US</td>
</tr>
<tr>
<td>105</td>
<td>Gerard</td>
<td>Depardieu</td>
<td>Mathematics</td>
<td>FR</td>
</tr>
<tr>
<td>102</td>
<td>Steven</td>
<td>Smith</td>
<td>Mathematics</td>
<td>UK</td>
</tr>
<tr>
<td>104</td>
<td>Ekaterina</td>
<td>Mihailov</td>
<td>Physics</td>
<td>RUS</td>
</tr>
</tbody>
</table>
<p><code>Sort</code> operator emits following table (where rows are ordered such that <code>Column=id</code> is ascending):</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>surname</th>
<th>major</th>
<th>country</th>
</tr>
</thead>
<tbody>
<tr>
<td>101</td>
<td>Jack</td>
<td>Hu</td>
<td>CS</td>
<td>US</td>
</tr>
<tr>
<td>102</td>
<td>Steven</td>
<td>Smith</td>
<td>Mathematics</td>
<td>UK</td>
</tr>
<tr>
<td>103</td>
<td>Mustafa</td>
<td>Demir</td>
<td>Mathematics</td>
<td>TUR</td>
</tr>
<tr>
<td>104</td>
<td>Ekaterina</td>
<td>Mihailov</td>
<td>Physics</td>
<td>RUS</td>
</tr>
<tr>
<td>105</td>
<td>Gerard</td>
<td>Depardieu</td>
<td>Mathematics</td>
<td>FR</td>
</tr>
</tbody>
</table>
<p><code>Filter</code> operator emits table below:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>surname</th>
<th>major</th>
<th>country</th>
</tr>
</thead>
<tbody>
<tr>
<td>102</td>
<td>Steven</td>
<td>Smith</td>
<td>Mathematics</td>
<td>UK</td>
</tr>
<tr>
<td>103</td>
<td>Mustafa</td>
<td>Demir</td>
<td>Mathematics</td>
<td>TUR</td>
</tr>
<tr>
<td>105</td>
<td>Gerard</td>
<td>Depardieu</td>
<td>Mathematics</td>
<td>FR</td>
</tr>
</tbody>
</table>
<p>where rows that do not have <code>major=Mathematics</code> (<code>rows:{1,4}</code>) are removed as before.</p>
<p>Then <code>Projection</code> at the end emits following data</p>
<table>
<thead>
<tr>
<th>name</th>
<th>surname</th>
</tr>
</thead>
<tbody>
<tr>
<td>Steven</td>
<td>Smith</td>
</tr>
<tr>
<td>Mustafa</td>
<td>Demir</td>
</tr>
<tr>
<td>Gerard</td>
<td>Depardieu</td>
</tr>
</tbody>
</table>
<p>which is the same result as before. Unlike previous case, this plan carries lots of unnecessary data between operators.</p>
<p>Let’s examine the problems in the second plan</p>
<ul>
<li><code>Sort</code> operator receives whole table, then reorders its rows. Since sorting is relatively costly, we want to minimize data entering sort as much as possible. After sorting, <code>Filter</code> operator filters out some of the rows that is sorted. In this case there was no point in sorting those rows in the first place. As comparison <code>Sort</code> in the first plan receives 3 rows, however in the second plan it receives 5 rows. If the <code>Filter</code> were to prune 90% of the rows, the difference would be more dramatic. With this observation, we want <code>Filter</code> operation to be as below as possible during the execution to not carry around some rows unnecessarily.</li>
<li><code>Filter</code> operator receives <code>Column=id, Column=country</code> However, <code>Filter</code> itself doesn’t use these columns (it requires <code>Column=major</code> for its calculation). Also this column is not asked by the end user in the query (where user wants to see only <code>name</code>, <code>surname</code>). This column is passed to subsequent operator only to be pruned by projection there (This might not be important in terms of computation. However, it is important in terms of memory usage, and data traffic. Table at the source could have <code>100</code>s of columns).</li>
</ul>
<p>In this blog post, we have analyzed two <code>Logical Plan</code>s to see the difference query optimization can make (In more complex queries difference can be much more dramatic). In subsequent posts we will analyze</p>
<ul>
<li>Filter Push-down</li>
<li>Projection Optimization</li>
</ul>
<p>with these optimization steps, we can convert following naive plan</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token operator">+</span><span class="token comment">--------------+------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> plan_type    <span class="token operator">|</span> <span class="token keyword keyword-plan">plan</span>                                                                               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> logical_plan <span class="token operator">|</span> Projection: student_table<span class="token punctuation">.</span>name<span class="token punctuation">,</span> student_table<span class="token punctuation">.</span>surname                              <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>   Filter: student_table<span class="token punctuation">.</span>major <span class="token operator">=</span> Utf8<span class="token punctuation">(</span><span class="token string">"Mathematics"</span><span class="token punctuation">)</span>                                <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>     Sort: student_table<span class="token punctuation">.</span>id <span class="token keyword keyword-ASC">ASC</span> NULLS <span class="token keyword keyword-LAST">LAST</span>                                          <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>       TableScan: student_table projection<span class="token operator">=</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> surname<span class="token punctuation">,</span> major<span class="token punctuation">,</span> country<span class="token punctuation">]</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------------------------------------------------------------------------------+</span>
</code></pre><p>to its optimized version</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token operator">+</span><span class="token comment">--------------+-----------------------------------------------------------------------------+</span>
<span class="token operator">|</span> plan_type    <span class="token operator">|</span> <span class="token keyword keyword-plan">plan</span>                                                                        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+-----------------------------------------------------------------------------+</span>
<span class="token operator">|</span> logical_plan <span class="token operator">|</span> Projection: student_table<span class="token punctuation">.</span>name<span class="token punctuation">,</span> student_table<span class="token punctuation">.</span>surname                       <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>   Sort: student_table<span class="token punctuation">.</span>id <span class="token keyword keyword-ASC">ASC</span> NULLS <span class="token keyword keyword-LAST">LAST</span>                                     <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>     Projection: student_table<span class="token punctuation">.</span>name<span class="token punctuation">,</span> student_table<span class="token punctuation">.</span>surname<span class="token punctuation">,</span> student_table<span class="token punctuation">.</span>id <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>       Filter: student_table<span class="token punctuation">.</span>major <span class="token operator">=</span> Utf8<span class="token punctuation">(</span><span class="token string">"Mathematics"</span><span class="token punctuation">)</span>                     <span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">|</span>         TableScan: student_table projection<span class="token operator">=</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> surname<span class="token punctuation">,</span> major<span class="token punctuation">]</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+-----------------------------------------------------------------------------+</span>
</code></pre><p>where unnecessary data is not carried between operators.</p>
<h2 id="references">References </h2>
<p><a href="https://arrow.apache.org/datafusion/">Apache Datafusion Documentation</a><br>
<a href="https://github.com/apache/arrow-datafusion">Apache Datafusion Project Github Page</a></p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>